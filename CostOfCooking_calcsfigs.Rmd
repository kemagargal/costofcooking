---
title: "Supplementary Information for *The cost of cooking for foragers*"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Kate Magargal"
date: "2/4/2021"
output: html_document
bibliography: "coc.bib"
---

```{r invisiblestuff, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
#setwd("C:/Users/Kate/Box Sync/Researcheez/Firewood_DB_proj/4.0_RR/FirewoodModelAnalysis_4RR") #home
```

## Introduction

[citation/doi of journal article will appear here once available]

This markdown document is the supplement material to the paper *The cost of cooking for foragers*. This document provides

1. a walk through a step-by-step derivation of how cooking increases the bioavailability of calories for *Perideridia gairdneri*, how that benefit is lost as the cost of cooking increases, and produce figure 2 from the main text,

2. code to calculate the increase in bioavailability of calories with cooking for the rest of the Great Basin prey items, as well as how that benefit is impacted by the costs of cooking, and produce figures [].

**First, some setup:**

Libraries needed to recreate figures and plot parameter setup:
```{r plotsetup, message=FALSE}
library(RColorBrewer)
library(cartography)
library(fields)

opar <- par()
par(pty="s", 
    mfrow=c(1,2),
    oma = c(0, 0, 0, 0),
    mar=c(4,4,2,2))
```

**Functions**

The function `cookperet` returns the cooked post-encounter return rate given the caloric bioavailability of cooked items, the handling time ('h'), and the added handling time for cooking (`cooking_cost`)
```{r cookfuncdef}
cookfunc <- function(e_cooked, h, cooking_cost) {e_cooked/(h+cooking_cost)}
```

The function `cookclimcalc` calculates the *cooking cost limit*, or the maximum time one should spend to cook an item based on the post-encounter return rate for that item.
```{r cooklimcalcdef}
cooklimcalc <- function(preydat) {

  for (i in (1:length(preydat$label))){
      e_cooked <- preydat$e_cooked[i] #assign cooked caloric value for prey item
      h <- preydat$h_hrs.per.kg[i] #assign non-cooking standard estimated hanglind time for prey item
      cooking_cost <- seq(from= 0, to=6, by=.01) #create sequence of cooking costs to analyze
      cook <- cookfunc(e_cooked, h, cooking_cost) #a set of e/h values for each cooking_cost value
      i #checkpoint that loop is working
      
      ydiff <- preydat$peret_cooked[i] - preydat$post.encounter.return_bombcal[i] #calculate difference between cooked and raw e/h (no cooking cost)
      ylim <- c(preydat$post.encounter.return_bombcal[i]-ydiff, preydat$peret_cooked[i]+ydiff)
      
        #calculate the cooking limit (place where curve crosses below raw value)
      pts<- approx(data.frame(cook, cooking_cost), xout = preydat$post.encounter.return_bombcal[i]) #solves for value in question, but flips x and y

        #####third, assign values and export csv
      preydat$cooklim[i]<-pts$y
      preydat$cookperetdiff[i]<-ydiff
    }
 # preydat<-return(preydat)
  write.csv(preydat, "preydatcalcs.csv")
  }
```

**Data**

These two data tables contain all the information needed for the analysis. The first table is the same as table [] in the paper, and contains reported nutritional values for Great Basin prey items. The second table, table [] in the paper, provides the *cooking transforms* used in the analysis, with values derived from [@boback_cooking_2007; @carmody_energetic_2009; @carmody_energetic_2011; @groopman_cooking_2015]
```{r preydatload}
preydat <- read.csv("preyattribs.csv")
preydat
```

```{r cooktransload}
cooktrans <- read.csv("cookingtransforms.csv")
cooktrans
```

**Atwater estimates**

First, I calculate Atwater estimates for each prey type, given the percentage of protein, lipids, and carbohydrates reported in the literature. Here, I use the basic Atwater 4-9-4 formula, estimating 4 calories for each gram of protein, 9 calories for each gram of lipids, and 4 calories for each gram of carbohydrates [@atwater_report_1897].

```{r atwatercalcs}
preydat$kcal_perkg_prot <- 4*1000*(preydat$pcnt_protein/100)
preydat$kcal_perkg_lipids <- 9*1000*(preydat$pcnt_lipids/100)
preydat$kcal_perkg_carb <- 4*1000*(preydat$pcnt_carbs/100)

preydat$total_atwater_kcal <- preydat$kcal_perkg_carb + preydat$kcal_perkg_lipids + preydat$kcal_perkg_prot

preydat$atwater_peret <- preydat$total_atwater_kcal/preydat$h_hrs.per.kg
```

## *Perideridia gairdneri* (common yampah) example

Lets run through the model with a specific example, P. gairdneri. The reasons for choosing this prey item are:
1) It is broadly recorded as an important and commonly utilized prey item throughout it's range in western North America, including among Numic foragers.
2) Ethnohistoric records indicate it was eaten both raw and cooked. This analysis can lend some insight into economic explanations of why and when cooking should occur to an item that can be consumed raw.
3) A detailed analysis of the nutritional components of P. gairderi root material was conducted by Kaldy et. al 1980. This study describes the lab protocol in detail and - importantly - reports the carbohydrate breakdown between starch, sugars, and fiber. This is important because cooking primarily increases the bioavailability of calories from starch, but not so for the other forms of carbohydrates.


First, lets take a look at the values associated with the *P. gairdneri*, which is in the `preydat` data table. The sources of numbers reported in columns 3-8 can be found in table [] of the paper.
```{r yampdat}
preydat[preydat$label=="common_yampah",]
```

In this analysis, the Atwater estimates of caloric yield approximate the cooked value of the prey item. In this next chunk, I calculate the raw caloric value of a kilogram of *P. gairderi* (`eraw_yamp`) as well as the post-encounter return rate of a raw kilogram (`peretraw_yamp`). The raw caloric value is calculated by dividing the caloric value of each macronutrient by the *cooking transform*.
```{r yamprawcalc}
eraw_yamp <- preydat$kcal_perkg_carb[preydat$label=="common_yampah"]/cooktrans$C_i[cooktrans$Macronutrient_Type=="Starch-USO"] + preydat$kcal_perkg_prot[preydat$label=="common_yampah"]/cooktrans$C_i[cooktrans$Macronutrient_Type == "Protein"] + preydat$kcal_perkg_lipids[preydat$label=="common_yampah"]/cooktrans$C_i[cooktrans$Macronutrient_Type == "Fat"]
eraw_yamp

peretraw_yamp <- eraw_yamp/preydat$h_hrs.per.kg[preydat$label=="common_yampah"]
peretraw_yamp
```

Now, I will prepare the data to produce panel a. of figure [] from the paper, which allows for an examination of how the post-encounter return rate of *P. gairderi* shifts as the cost of cooking increases.

The next code chunk takes the steps below to caclulate the *cooking cost limit* for *P. gairdneri*

1. create a range of cooking costs (in this case, from 0-2 hours, by intervals of .01 hours),
2. calculate the range of post-encounter return rates based on the range of cooking costs,
3. calculate the *cooking cost limit*, or the maximum cost of cooking that should be paid, as any additional costs would make the post-encounter return rate of the cooked item lower than the raw item.
```{r plotpdat}
#1
cooking_cost <- seq(from= 0, to=2, by=.01)

#2
yampperetrange<- cookfunc(e_cooked = preydat$total_atwater_kcal[preydat$label=="common_yampah"], h = preydat$h_hrs.per.kg[preydat$label=="common_yampah"], cooking_cost) #calculates the post-encounter return rate of yampa across a range of cooking costs

#3
#Calculate the cooking cost limit based on where the curve (drawn by the change in yampperetrange with cooking_cost) for the maximum C_i
newy<- peretraw_yamp #the post-encounter return rate of raw yampa, for which we will solve the x position of the curve since one recieves no benefit from cooking beyond that point
ptsmax<- approx(data.frame(yampperetrange, cooking_cost), xout = newy ) #solves for value in question, but flips x and y
ptsmax$y #the cost of cooking value beyond which cooking should not occur if the cooking transform is the maximum
```

So, the *cooking cost limit* of *P. garideri* is `r ptsmax$y`.

Next, I will set up a dataframe that allows for a sensitivity analysis on the values used in the *cooking transform* (`C_i`). The next code chunk produces the same calculations of raw values and *cooking cost limit* done up to this point, except varies the value of `C_i` in increments from 10% of the reported value to 100% of the reported value for starch.

The steps conducted in the following code are:
1. set up a data fram called `plotp` with a column called `nums` that indicates which proportion of `C_i` is calculated for that row,
2. calculate values of `C_i` for a sensitivity analysis,
3. calculate a raw energetic yield (`eraw`) and post-encounter return rate (`peretraw`) for each value of `C_i`,
4. return the resulting data frame called `plotp`.
```{r}
#1
plotp <- data.frame(nums=seq(from = .1, to = 1, by= .1), x="NA", y="NA", stringsAsFactors = FALSE)

#2
plotp$x<- cooktrans$bioavail_incr_pcnt[cooktrans$Macronutrient_Type=="Starch-USO"]*plotp$nums/100+1

#3
plotp$eraw <- (
      preydat$kcal_perkg_carb[preydat$label=="common_yampah"]/plotp$x
      + preydat$kcal_perkg_prot[preydat$label=="common_yampah"]/cooktrans[4,3]
      + preydat$kcal_perkg_lipids[preydat$label=="common_yampah"]/cooktrans[5,3]
      )

plotp$peretraw <-  plotp$eraw/preydat$h_hrs.per.kg[preydat$label=="common_yampah"]
plotp
```

This next code chunk plots panel a. from figure []. To do this, it incporporates a for loop that calculates the *cooking cost limit* (`plotp$y`) in the same way as shown above, but for all values of `C_i`, completing the sensitivity analysis. For each value of `C_i`, a new polygon representing all the possible values for cooked *P. gairderi* is plotted, each in a lighter shade of grayscale. Black represents 10% `C_i`, with a *cooking cost limit* of `r plotp$y[plotp$nums==0.1]`. 100% of `C_i` (the amount derived from literature) is represented by the lightest gray, with a cooking cost limit of `r plotp$y[plotp$nums==1.0]`
```{r plota}
#plot parameter setup
#pdf(file = "YampaPlot.pdf", width = 6, height = 6)

grays <- gray.colors(10, .1) #define the grays to be used in shading
plot(NA, cex.lab = 1.25, cex.axis = 1, xlim = c(0, 1.2), xlab = "Cooking Cost (hrs)", ylim = c(0,preydat$atwater_peret[preydat$label=="common_yampah"]+1000), ylab = "Post-encounter Return Rate (kcal/hr)")

#calculate and draw polygons for range of values of C_i, with darker grays as benefit of cooking decreases
for (i in nrow(plotp):1){
  newy<- plotp$peretraw[i]
  newy #the raw post-encounter return rate of yampa, for which we will solve the x position of the curve
  ptsmax<- approx(data.frame(yampperetrange, cooking_cost), xout = newy ) #solves for value in question, but flips x and y
  plotp$y[i]<- ptsmax$y #the cost of cooking value beyond which cooking should not occur given the C_i
  plotp <- as.data.frame(sapply(plotp, as.numeric))
  coord.x<- c(0, seq(from= 0, to=plotp$y[i], by=.01), plotp$y[i])
  coord.y<- c(plotp$peretraw[i],
            preydat$atwater_peret[preydat$label=="common_yampah"], 
            cookfunc(preydat$total_atwater_kcal[preydat$label=="common_yampah"], preydat$h_hrs.per.kg[preydat$label=="common_yampah"], seq(from=.01, to=plotp$y[i], by=.01)), 
            cookfunc(preydat$total_atwater_kcal[preydat$label=="common_yampah"], preydat$h_hrs.per.kg[preydat$label=="common_yampah"], plotp$y[i]))

  polygon(coord.x, coord.y, col = grays[i], border = NA)
}

abline(v=max(plotp$y), lty=5)
abline(v=0, lty=5)
text(max(plotp$y)/2, 
     min(plotp$peretraw)/2,
     "No cooking \n outside this \n interval",
     col = 'black')

arrows(.6, 1250, max(plotp$y)-.01, 1250, length = .1)
arrows(.16, 1250, .01, 1250, length = .1)

abline(h = min(plotp$peretraw), col = 'blue', lwd = 2) #raw value
text(.91, min(plotp$peretraw)+255, "raw e/h", col = 'blue')
abline(h = preydat$atwater_peret[preydat$label=="common_yampah"], col = 'red', lwd = 2) #cooked value
text(.975, preydat$atwater_peret[preydat$label=="common_yampah"]+250, "cooked e/h", col = 'red')
lines(yampperetrange~cooking_cost, lwd=2, col="black", lty=1)

colorbar.plot(1, 4000, strip = c(1:length(grays)), col = grays, strip.width = .1, strip.length = .25, horizontal = FALSE)
text(1.15, 4750, "+")
text(1.15, 4000, expression(italic("C")[italic("i")]))
text(1.15, 3300, "-")
mtext("a.", side = 3, line = 0.3, outer = FALSE, adj = 0, cex = 1.5)
```

Panel b. from figure [] in the text plots how the *cooking cost limit* changes as a function of `C_i` as the total amount of carbohydrates varies. This serves as another sensitivity analysis, examining the relationship between how much time is worth investing in cooking if the carbohydrate content of a USO is low vs. high. This is an important consideration for forager studies since the carbohydrate content (especially starch) varies seasonally.
```{r plotb}
plot(NA, cex.lab = 1.25, cex.axis = 1, xlim = c(1.2,2.25), xlab = expression(italic("C")[italic("i")]), ylim = c(0, 6.5), ylab = "Cooking Cost Limit (hrs)")

# #with the reported (100%) starch content
# cooklm<- lm(y ~ x, data = plotp)
# abline(cooklm, lwd = 3, lty = 1, col = grays[1])

getPalette = colorRampPalette(brewer.pal(9, "OrRd"))
grad<-carto.pal("blue.pal", 10)

for(i in nrow(plotp):1){
#  cookedperet.it<-(yampdat$at_starch_pkg*.1*i+yampdat$at_prot_pkg+yampdat$at_lip_pkg)/yampdat$yamph #calculate the cooked peret for each C_i for the starch percentage represented in this iteration
  
  plotp$eraw.it<- 
    preydat$kcal_perkg_carb[preydat$label=="common_yampah"]*.1*i/plotp$x +
    preydat$kcal_perkg_prot[preydat$label=="common_yampah"]/cooktrans[4,3] +
    preydat$kcal_perkg_lipids[preydat$label=="common_yampah"]/cooktrans[5,3]#calculate the raw e for each C_i for the starch percentage 
  
  plotp$peretraw.it <- plotp$eraw.it/preydat$h_hrs.per.kg[preydat$label=="common_yampah"]
  
  plotp$y.it <- NA
  cooking_cost <- seq(from= 0, to=6, by=.01) #represents a range of cooking costs between no cost and 2 hours
  yampperetrange<- cookfunc(e_cooked = preydat$total_atwater_kcal[preydat$label=="common_yampah"], h = preydat$h_hrs.per.kg[preydat$label=="common_yampah"], cooking_cost) #calculates the post-encounter return rate of yampa across a range of cooking costs

  for(j in 1:nrow(plotp)){
#    yampcook.itit <- cookfunc(plotp$ecooked.it[j], yampdat$yamph, cooking_cost)#calculates the peret for cooking cost for 10% starch
    newy<- plotp$peretraw.it[j]

    ptsfor<- approx(data.frame(yampperetrange, cooking_cost), xout = newy) #solves for the point location where the curve crosses the line (representing raw value), but flips x and y
    plotp$y.it[j]<-ptsfor$y
    
  }

  cooklm.it<- lm(y.it ~ x, data = plotp, na.action = na.omit)
  abline(cooklm.it, lwd = 2.5, lty = 1, col = grad[i])
}

colorbar.plot(1.275, 5.35, strip = c(1:length(grad)), col = grad, strip.width = .1, strip.length = .25, horizontal = FALSE)
 text(1.275, 6.5, "100%")
 text(1.53, 5.2, "% reported \n starch content")
 text(1.275, 4.3, "10%")
 mtext("b.", side = 3, line = 0.3, outer = FALSE, adj = 0, cex = 1.5)
```

Panel b. shows that, when carboyhdrate content is high, the *cooking cost limit* should remain relatively low, regardless of the `C_i`. If the carbohydrate content is low, the *cooking cost limit* is much higher, ranging in this case around 4-5 hours of investment worth making before the post-encounter return rate drops lower than eating the item raw. 

In order to further explore the cooking trade-off for when *P. gairderi* contains little carbohydrates (which may represent it's condition immediately after it expended energy flowering in late spring), the following code chunk produces a supplementary figure similar to panel a. above, but with 10% of the reported carbohydrate content.
```{r periplottenpcnt}
par(opar)
grays <- gray.colors(10, .1) #define the grays to be used in shading
plot(NA, cex.lab = 1.25, cex.axis = 1, xlim = c(0, 6), xlab = "Cooking Cost (hrs)", ylim = c(0,preydat$atwater_peret[preydat$label=="common_yampah"]+1000), ylab = "Post-encounter Return Rate (kcal/hr)")

for (i in nrow(plotp):1){

  coord.x<- c(0, seq(from= 0, to=plotp$y.it[i], by=.01), plotp$y.it[i])
  coord.y<- c(plotp$peretraw.it[i],
            preydat$atwater_peret[preydat$label=="common_yampah"], 
            cookfunc(preydat$total_atwater_kcal[preydat$label=="common_yampah"], preydat$h_hrs.per.kg[preydat$label=="common_yampah"], seq(from=.01, to=plotp$y.it[i], by=.01)), 
            cookfunc(preydat$total_atwater_kcal[preydat$label=="common_yampah"], preydat$h_hrs.per.kg[preydat$label=="common_yampah"], plotp$y.it[i]))

  polygon(coord.x, coord.y, col = grays[i], border = NA)
}

abline(v=max(plotp$y.it), lty=5)
abline(v=0, lty=5)

abline(h = plotp$peretraw.it[10], col = 'blue', lwd = 2) #raw value
abline(h = preydat$atwater_peret[preydat$label=="common_yampah"], col = 'red', lwd = 2) #cooked value
lines(yampperetrange~cooking_cost, lwd=2, col="black", lty=1)
colorbar.plot(4, 4000, strip = c(1:length(grays)), col = grays, strip.width = .05, strip.length = .15, horizontal = FALSE)
text(4.25, 4750, "+")
text(4.25, 4000, expression(italic("C")[italic("i")]))
text(4.25, 3300, "-")
```

In this case, the raw post-encounter return rate is calculated as being $\geq$ `r min(plotp$peretraw.it)` and $\leq$ `r max(plotp$peretraw.it)`. Therefore, it takes quite a long investment in time for the post-encounter return rate of a cooked item to decrease below the low raw value. For the highest value of `C_i`, the *cooking cost limit* is `r max(plotp$y.it)`.


Lets explore a few other aspects of the cooking trade-off for *P. gairderi*. What is the change in bioavailable calories (*e*, per kilogram)?

When `C_i` = 2.24, and carbohydrate values are 100% of what was reported in the literature:
```{r}
preydat$total_atwater_kcal[preydat$label=="common_yampah"]-plotp$eraw[10]
```

When `C_i` = 1.124, and carbohydrate values are 100% of what was reported in the literature:
```{r}
preydat$total_atwater_kcal[preydat$label=="common_yampah"]-plotp$eraw[1]
```

How about the change in the post-encounter return rate of *P. gairdneri*?

When `C_i` = 2.24, and carbohydrate values are 100% of what was reported in the literature:

```{r}
preydat$atwater_peret[preydat$label=="common_yampah"]-plotp$peretraw[10]
```

When `C_i` = 1.124, and carbohydrate values are 100% of what was reported in the literature:
```{r}
preydat$atwater_peret[preydat$label=="common_yampah"]-plotp$peretraw[1]
```

This number reflects the increase in post-encounter return rates (in kcal/kg) if cooking can happen instantaneously with no added handling time. Of course, importantly, this is never the case. Yampa should be cooked any time the handling cost of cooking (added to other handling costs) is no greater than the *cooking cost limit*, or the point where the post-encounter return rate falls below the raw post-encounter return rate. For yampa, this cost threshold is:
```{r}
plotp$y[10] #the cooking cost limit when C_i=2.24
plotp$y[1] #the cooking cost limit when C_i=1.124 (10% of the maximum 124% value for C_i)
```

So, while a prey item like the common yampa would beneficially be cooked, one should never choose to cook it if the cost of cooking ranges much above .77 hours/kg.


# References

